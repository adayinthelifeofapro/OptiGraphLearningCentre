@inject IGraphQLClient GraphQLClient

<div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
    <!-- Tabs -->
    <div class="flex border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
        <button @onclick="() => _activeTab = Tab.Query"
                class="@GetTabClass(Tab.Query)">
            Query
        </button>
        <button @onclick="() => _activeTab = Tab.Result"
                class="@GetTabClass(Tab.Result)">
            Result
        </button>
    </div>

    <!-- Content -->
    <div class="bg-gray-900 dark:bg-gray-950 text-gray-100">
        @if (_activeTab == Tab.Query)
        {
            <textarea @bind="_query"
                      class="w-full h-64 p-4 font-mono text-sm bg-transparent resize-none focus:outline-none"
                      spellcheck="false"></textarea>
        }
        else
        {
            <div class="h-64 overflow-auto p-4">
                @if (_isRunning)
                {
                    <div class="flex items-center justify-center h-full">
                        <LoadingSpinner Message="Running query..." />
                    </div>
                }
                else if (string.IsNullOrEmpty(_result))
                {
                    <p class="text-gray-500 italic">Run the query to see results</p>
                }
                else
                {
                    <pre class="font-mono text-sm whitespace-pre-wrap">@_result</pre>
                }
            </div>
        }
    </div>

    <!-- Actions -->
    <div class="flex items-center justify-between px-4 py-3 bg-gray-50 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700">
        <div class="flex items-center gap-4">
            @if (Example.Hints.Any())
            {
                <button @onclick="ShowNextHint"
                        class="text-sm text-gray-500 dark:text-gray-400 hover:text-opti-blue dark:hover:text-blue-400 transition-colors">
                    Show Hint (@(_hintIndex + 1)/@Example.Hints.Count)
                </button>
            }
        </div>

        <div class="flex gap-2">
            <button class="btn-secondary text-sm py-1.5" @onclick="ResetQuery">
                Reset
            </button>
            <button class="btn-primary text-sm py-1.5" @onclick="RunQuery" disabled="@_isRunning">
                @if (_isRunning)
                {
                    <span class="flex items-center gap-2">
                        <span class="spinner w-3 h-3"></span>
                        Running...
                    </span>
                }
                else
                {
                    <span class="flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Run Query
                    </span>
                }
            </button>
        </div>
    </div>

    <!-- Hints -->
    @if (_showHint && _hintIndex < Example.Hints.Count)
    {
        <div class="mx-4 mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/30 border border-yellow-200 dark:border-yellow-800 rounded-lg">
            <div class="flex items-start gap-2">
                <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                </svg>
                <div>
                    <p class="text-sm font-medium text-yellow-800 dark:text-yellow-200">Hint @(_hintIndex + 1)</p>
                    <p class="text-sm text-yellow-700 dark:text-yellow-300">@Example.Hints[_hintIndex]</p>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public LessonExample Example { get; set; } = default!;

    private enum Tab { Query, Result }

    private Tab _activeTab = Tab.Query;
    private string _query = string.Empty;
    private string _result = string.Empty;
    private bool _isRunning;
    private bool _showHint;
    private int _hintIndex;

    protected override void OnParametersSet()
    {
        if (Example != null)
        {
            _query = Example.GraphQLQuery;
            _result = string.Empty;
            _showHint = false;
            _hintIndex = 0;
        }
    }

    private async Task RunQuery()
    {
        _isRunning = true;
        _activeTab = Tab.Result;
        StateHasChanged();

        try
        {
            var request = new GraphQLRequest { Query = _query };
            var response = await GraphQLClient.ExecuteAsync(request);

            var options = new System.Text.Json.JsonSerializerOptions { WriteIndented = true };

            if (response.HasErrors)
            {
                // Show errors from GraphQL response
                _result = System.Text.Json.JsonSerializer.Serialize(
                    new { errors = response.Errors },
                    options
                );
            }
            else if (response.Data is { } data && data.ValueKind != System.Text.Json.JsonValueKind.Undefined)
            {
                // Serialize the data if it's valid
                _result = System.Text.Json.JsonSerializer.Serialize(data, options);
            }
            else
            {
                // No data returned
                _result = System.Text.Json.JsonSerializer.Serialize(
                    new { message = "No data returned. Check your credentials in Settings." },
                    options
                );
            }
        }
        catch (Exception ex)
        {
            _result = System.Text.Json.JsonSerializer.Serialize(
                new { error = ex.Message },
                new System.Text.Json.JsonSerializerOptions { WriteIndented = true }
            );
        }
        finally
        {
            _isRunning = false;
        }
    }

    private void ResetQuery()
    {
        _query = Example.GraphQLQuery;
        _result = string.Empty;
        _activeTab = Tab.Query;
        _showHint = false;
        _hintIndex = 0;
    }

    private void ShowNextHint()
    {
        _showHint = true;
        if (_hintIndex < Example.Hints.Count - 1)
        {
            _hintIndex++;
        }
    }

    private string GetTabClass(Tab tab)
    {
        var baseClass = "px-4 py-2 text-sm font-medium border-b-2 -mb-px transition-colors";
        return _activeTab == tab
            ? $"{baseClass} border-opti-blue text-opti-blue dark:text-blue-400 dark:border-blue-400 bg-white dark:bg-gray-900"
            : $"{baseClass} border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200";
    }
}
